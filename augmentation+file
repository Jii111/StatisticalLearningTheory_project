import os
import numpy as np
import cv2
from PIL import Image
from torchvision import transforms
import albumentations


def image_augmentation(image_folder, output_folder):
    img_files = [f for f in os.listdir(image_folder) if f.endswith(('.jpg'))]

    # 결과 이미지를 저장할 폴더 생성
    os.makedirs(output_folder, exist_ok=True)

    for img_file in img_files:
        img_path = os.path.join(image_folder, img_file)
        img = cv2.imread(img_path)

        imgArray = np.array(img)  # 이미지 분석을 위해 배열 전환
        imgArray = cv2.cvtColor(imgArray, cv2.COLOR_BGR2RGB)  # BGR에서 RGB로 변환

        # torchvision을 이용하여 밝기, 대비, 채도, 색상을 조절(4가지 생성)
        loader_transform1 = transforms.ColorJitter(brightness=2)
        loader_transform2 = transforms.ColorJitter(contrast=2)
        loader_transform3 = transforms.ColorJitter(saturation=2)
        loader_transform4 = transforms.ColorJitter(hue=0.3)

        img_aug1 = loader_transform1(Image.fromarray(imgArray))
        img_aug2 = loader_transform2(Image.fromarray(imgArray))
        img_aug3 = loader_transform3(Image.fromarray(imgArray))
        img_aug4 = loader_transform4(Image.fromarray(imgArray))

        # 1/2의 확률로 좌우반전
        transform1 = albumentations.HorizontalFlip(p=0.5)
        augmented_image1 = transform1(image=imgArray)['image']

        # 1/2 확률로 돌리거나 이동
        transform2 = albumentations.ShiftScaleRotate(p=0.5)
        augmented_image2 = transform2(image=imgArray)['image']

        # 결과 이미지 저장
        output_path1 = os.path.join(output_folder, f"augmented1_{img_file}")
        output_path2 = os.path.join(output_folder, f"augmented2_{img_file}")

        Image.fromarray(np.array(img_aug1)).save(output_path1)
        Image.fromarray(np.array(img_aug2)).save(output_path2)
        Image.fromarray(augmented_image1).save(os.path.join(output_folder, f"augmented3_{img_file}"))
        Image.fromarray(augmented_image2).save(os.path.join(output_folder, f"augmented4_{img_file}"))

# path to image folder
image_folder_path = '/content/drive/MyDrive/train/train'
# path to output folder
output_folder_path = '/content/drive/MyDrive/train_augmentation'
image_augmentation(image_folder_path, output_folder_path)
